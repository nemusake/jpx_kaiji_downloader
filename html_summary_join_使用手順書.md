# HTML Summary CSV結合ツール 使用手順書

## 1. 事前準備

### 1.1 必要な環境
- Python 3.x がインストールされていること
- ターミナル（コマンドプロンプト）が使用できること

### 1.2 ファイル配置の確認
```
作業フォルダ/
├── html_summary_join.py    # このファイルを配置
└── output/
    └── html_summary/        # CSVファイルが格納されているフォルダ
        ├── 13010.csv
        ├── 13320.csv
        ├── 130A0.csv
        └── ... （多数のCSVファイル）
```

## 2. 基本的な使い方

### 2.1 ヘルプの表示
使い方がわからない時は、まずヘルプを表示します。

```bash
cd 作業フォルダ
python3 html_summary_join.py
```

以下のようなヘルプが表示されます：
```
HTML Summary CSV結合ツール

使用方法:
    python html_summary_join.py                    # ヘルプを表示
    python html_summary_join.py all                # 全CSVファイルを結合
    python html_summary_join.py 20250101-20250701  # 日付範囲で結合（YYYYMMDD形式）
    python html_summary_join.py 13010-99840        # 証券コード範囲で結合
    python html_summary_join.py cleansing          # 証券コード・valueの全角→半角変換とクレンジング処理
```

### 2.2 全データを結合する場合
全ての証券コードのデータを1つのファイルにまとめたい場合：

```bash
python3 html_summary_join.py all
```

**実行例：**
```
全結合モード: フォルダ内の全CSVファイルを結合します

処理対象ファイル数: 1671
処理を開始します...

処理中: 13010.csv (3638行)
処理中: 13320.csv (3808行)
...
==================================================
処理完了
処理ファイル数: 1671
総レコード数: 5634521
出力ファイル: output/html_summary_all.csv
==================================================
```

**注意：** 
- 処理に数分かかります
- 出力ファイルは数GBになる可能性があります

### 2.3 データクレンジング処理
データの品質向上のため、証券コードとvalueカラムの全角→半角変換と数値正規化を行う場合：

```bash
python3 html_summary_join.py cleansing
```

**実行例：**
```
クレンジングモード: 証券コードの正規化処理を実行します
処理対象ファイル数: 1671
クレンジング処理を開始します...

[3/1671] 13330.csv: code 1423行、value 527行を修正
[4/1671] 13750.csv: value 281行を修正
[10/1671] 処理中...
==================================================
クレンジング処理完了
処理ファイル数: 1671
修正ファイル数: 800
総レコード数: 5634521
証券コード修正レコード数: 450000
valueカンマ除去レコード数: 800000
==================================================
```

**処理される変換例：**
- 証券コード: `１３３３０` → `13330` （全角→半角）
- 証券コード: `1333` → `13330` （4桁→5桁）
- valueカラム（数値データ）: `１，２３４，５６７` → `1234567` （全角→半角+カンマ除去）
- valueカラム（文字データ）: 変換されない

**クレンジング処理の内容：**
- 証券コードの全角英数字を半角に正規化（例: `１３３３０` → `13330`）
- 4桁の証券コード（例: `1333`）を5桁（例: `13330`）に修正
- valueカラムが数値データの場合：
  - 全角数字を半角に正規化（例: `１，２３４` → `1234`）
  - 3桁区切りカンマを除去（例: `"1,234,567"` → `1234567`）
- ファイル名と証券コードの整合性を保つ
- 修正が必要なファイルのみを更新（効率的処理）
- SQLite3データベース格納用に数値を正規化

**注意：**
- 元のCSVファイルが直接更新されます（バックアップ推奨）
- 処理に数分かかる場合があります
- 修正が必要ないファイルはスキップされます
 - 対象は「ファイル名が4〜5文字の英数字」のCSVのみです

## 3. 条件を指定した結合

### 3.1 特定期間のデータを抽出
2020年のデータのみを抽出したい場合：

```bash
python3 html_summary_join.py 20200101-20201231
```

**実行例：**
```
日付範囲モード: 2020-01-01 から 2020-12-31

処理対象ファイル数: 1671
処理を開始します...

処理中: 13010.csv (342行)
処理中: 13320.csv (341行)
...
出力ファイル: output/html_summary_date_20200101-20201231.csv
```

**ポイント：**
- 日付は`YYYYMMDD`形式で指定
- CSVファイル内のdateカラムを参照してフィルタリング
- 全ファイルを読み込むため、ファイル数が多い場合は時間がかかります
 - CSVの`date`カラムは`YYYY-MM-DD`形式を想定しています

### 3.2 特定の証券コード範囲を抽出
13000番台の企業のみを抽出したい場合：

```bash
# 数字のみの証券コード
python3 html_summary_join.py 13000-13999

# アルファベット付きも含める場合
python3 html_summary_join.py 13000-139ZZ
```

**実行例：**
```
証券コード範囲モード: 13000 から 139ZZ

処理対象ファイル数: 15
処理を開始します...

処理中: 13010.csv (3638行)
処理中: 13320.csv (3808行)
処理中: 130A0.csv (3521行)
...
出力ファイル: output/html_summary_code_13000-139ZZ.csv
```

## 4. 証券コード範囲指定の詳細

### 4.1 文字列比較の仕組み
証券コードは文字列として比較されます（辞書順）。

**比較順序の例：**
```
"13000" < "13099" < "130A0" < "130Z0" < "13100" < "13999" < "139A0" < "139ZZ"
```

### 4.2 よくある指定パターン

#### パターン1: 数字のみの証券コード
```bash
python3 html_summary_join.py 10000-19999
```
- 10000〜19999の数字コードのみ
- 100A0などのアルファベット付きは含まれない

#### パターン2: 特定の千番台（アルファベット付き含む）
```bash
python3 html_summary_join.py 13000-139ZZ
```
- 13000〜13999の数字コード
- 130A0〜139Z9などのアルファベット付きコード

#### パターン3: 幅広い範囲
```bash
python3 html_summary_join.py 10000-99ZZZ
```
- ほぼ全ての証券コードをカバー

### 4.3 注意点
- `13000-13999`では`130A0`は含まれません（"130A0" > "13999"のため）
- アルファベット付きコードを含めたい場合は終了値を`139ZZ`のようにする
- 末尾が0のコードのみの場合は`139Z0`でも可

## 5. 出力ファイルの確認

### 5.1 出力先
全ての出力ファイルは`output/`フォルダに保存されます。

| コマンド | 出力ファイル名 |
|---------|--------------|
| all | html_summary_all.csv |
| 日付範囲 | html_summary_date_YYYYMMDD-YYYYMMDD.csv |
| 証券コード範囲 | html_summary_code_XXXXX-XXXXX.csv |
| cleansing | 各CSVファイルを直接更新（出力ファイルなし） |

### 5.2 ファイルサイズの確認
```bash
ls -lh output/html_summary*.csv
```

### 5.3 データ件数の確認
```bash
# ヘッダー行を除いた行数を確認
tail -n +2 output/html_summary_all.csv | wc -l
```

## 6. トラブルシューティング

### 6.1 「処理対象のCSVファイルが見つかりません」と表示される
**原因：** output/html_summaryフォルダが存在しないか、CSVファイルがない

**対処法：**
```bash
# フォルダの存在確認
ls output/html_summary/

# 実行場所の確認
pwd
```

### 6.2 メモリ不足エラーが発生する
**原因：** データ量が多すぎてメモリに収まらない

**対処法：**
- 範囲を狭めて実行
- 日付範囲を1ヶ月単位にする
- 証券コード範囲を1000番台単位にする

### 6.3 処理が途中で止まる
**原因：** 特定のCSVファイルが破損している可能性

**対処法：**
- エラーメッセージを確認
- 該当ファイルを一時的に移動して再実行

### 6.4 Excelで開くと文字化けする
**原因：** UTF-8エンコーディングの認識問題

**対処法：**
- 出力ファイルはUTF-8 BOM付きなので、通常は問題ないはず
- Excelの「データ」→「テキストファイル」から開く
- UTF-8を指定して開く

### 6.5 クレンジング処理で「修正するデータがない」と表示される
**原因：** 既に全て5桁の証券コードになっていて、かつvalueカラムにカンマ区切り数値が存在しない

**対処法：**
- 正常な状態です。既にクレンジング済みか、処理の必要がありません
- 個別ファイルを確認したい場合は、CSVファイルを直接開いて確認

### 6.6 クレンジング処理が途中で止まる
**原因：** 特定のCSVファイルが破損している可能性

**対処法：**
- エラーメッセージを確認
- 該当ファイルは自動的にスキップされ、処理は継続されます
- 必要に応じて、該当ファイルを個別に確認・修復

## 7. 活用例

### 7.1 四半期ごとのデータ抽出
```bash
# 2024年第1四半期
python3 html_summary_join.py 20240401-20240630

# 2024年第2四半期
python3 html_summary_join.py 20240701-20240930
```

### 7.2 業種別データ抽出（証券コード範囲による）
```bash
# 水産・農林業（1300番台）
python3 html_summary_join.py 13000-139ZZ

# 建設業（1700-1900番台）
python3 html_summary_join.py 17000-199ZZ
```

### 7.3 データベースへのインポート準備
```bash
# まずデータクレンジングを実行
python3 html_summary_join.py cleansing

# 全データを1ファイルにまとめる
python3 html_summary_join.py all

# データベースにインポート（PostgreSQLの例）
psql -d database_name -c "\COPY table_name FROM 'output/html_summary_all.csv' WITH CSV HEADER"
```

### 7.4 データ品質向上のワークフロー
```bash
# 1. まずクレンジング処理でデータを正規化
#    - 証券コード: 全角→半角、4桁→5桁
#    - valueカラム: 全角→半角、カンマ除去で数値化
python3 html_summary_join.py cleansing

# 2. 特定期間のデータを抽出してチェック
python3 html_summary_join.py 20240101-20241231

# 3. 問題がなければ全データを結合
python3 html_summary_join.py all

# 4. SQLite3データベースにインポート
#    （valueカラムが数値として正しく格納される）
```

## 8. パフォーマンス目安

| 処理内容 | ファイル数 | 処理時間（目安） | 出力サイズ（目安） |
|---------|-----------|----------------|------------------|
| 全結合 | 1671 | 3-5分 | 2-3GB |
| 1年分の日付範囲 | 1671 | 2-4分 | 500MB |
| 1000番台の証券コード | 10-20 | 10秒 | 20-50MB |
| クレンジング処理 | 1671 | 2-4分 | 元ファイル更新 |

※ 処理時間はマシンスペックに依存します

## 9. 注意事項

- **既存ファイルの上書き**: 同名の出力ファイルは警告なしに上書きされます
- **クレンジング処理**: 元のCSVファイルが直接更新されるため、必要に応じてバックアップを取ってください
- **大容量ファイル**: 全結合時は数GBのファイルが生成される可能性があります
- **処理時間**: ファイル数が多い場合、処理に時間がかかります
- **メモリ使用**: 大量データ処理時は十分なメモリが必要です
 - **value修正件数の定義**: クレンジング結果の「valueカンマ除去レコード数」には、カンマ除去に限らず全角→半角のみの変更も含まれます（valueの内容が変化した行の総数）

## 10. お問い合わせ

問題が発生した場合は、以下の情報と共に報告してください：
- 実行したコマンド
- エラーメッセージ（あれば）
- CSVファイル数
- Python バージョン（`python3 --version`）
