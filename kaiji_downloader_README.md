# JPX適時開示情報ダウンローダー

東京証券取引所（JPX）の適時開示情報から企業の財務データを自動ダウンロードするPythonツールです。

## 🎯 プロジェクトの目的

- 東証上場企業の適時開示情報を自動収集
- 決算短信のXBRL、HTMLサマリー、添付資料を一括ダウンロード
- 財務指標データの構造化・分析基盤の構築

## 📋 機能概要

### 1. 企業情報検索・取得
- 証券コードによる企業基本情報の取得
- 適時開示情報の一覧表示

### 2. ファイルダウンロード機能
- **XBRLファイル**: 構造化された財務データ（.zipファイル）
- **HTMLサマリー**: インラインXBRL形式の財務情報（.iXBRL.htm）
- **添付資料**: 定性的情報・業績予想等（.qualitative.htm）

### 3. 実行モード
- 単一企業テスト
- 適時開示情報取得
- 各種ファイル個別ダウンロード
- 全ファイル一括ダウンロード
- CSVファイルからの一括処理

## 🛠 技術スタック

- **Python 3.11+**
- **uv**: 依存関係管理
- **BeautifulSoup4**: HTMLパースィング
- **requests**: HTTP通信
- **lxml**: XMLパーサー

## 📁 プロジェクト構造

```
jpx_kaiji_service/
├── kaiji_downloader.py         # メイン実行ファイル（旧main.py）
├── src/
│   └── scraper.py             # JPXスクレイピングクラス
├── downloads/                 # ダウンロードファイル保存先
│   ├── xbrl/{証券コード}/     # XBRLファイル
│   ├── html_summary/{証券コード}/ # HTMLサマリー
│   └── attachments/{証券コード}/  # 添付資料
├── data/                      # JSONデータ保存先
├── debug/                     # デバッグ用HTMLファイル
├── pyproject.toml            # プロジェクト設定
├── uv.lock                   # 依存関係ロックファイル
├── xbrl_financial_indicators.csv # 抽出可能財務指標一覧
├── テーブル構造.md            # JPX HTMLテーブル構造仕様
├── kaiji_downloader_README.md       # このファイル
└── kaiji_downloader_使用手順書.md # 詳細使用手順
```

## 🚀 クイックスタート

### 1. 環境構築
```bash
# uvがインストールされていない場合
curl -LsSf https://astral.sh/uv/install.sh | sh

# 依存関係のインストール
uv sync
```

### 2. 基本的な使用例
```bash
# 企業基本情報の取得
uv run python kaiji_downloader.py 99840

# 適時開示情報の表示
uv run python kaiji_downloader.py disclosure 99840

# XBRLファイルのダウンロード
uv run python kaiji_downloader.py xbrl 99840

# 全ファイル一括ダウンロード
uv run python kaiji_downloader.py all 99840
```

## 📊 取得可能データ

### 企業基本情報
- 証券コード
- 企業名
- 市場区分（プライム・スタンダード等）
- 業種
- 決算月

### 適時開示情報
- 開示日
- 資料タイトル
- PDFファイルURL
- XBRLファイルURL
- HTMLサマリーURL  
- 添付資料URL

### 財務指標（XBRLから抽出可能）
40種類以上の財務指標に対応：
- 売上高・営業利益・純利益
- 総資産・純資産・負債
- 1株当たり情報
- キャッシュフロー情報
- その他の財務比率

## 🔧 実装済み機能

### JPXスクレイピング
- ✅ 企業検索機能
- ✅ 適時開示情報取得
- ✅ HTMLテーブル構造解析
- ✅ URL抽出（PDF/XBRL/HTML/添付）

### ダウンロード機能
- ✅ XBRLファイルダウンロード
- ✅ HTMLサマリーダウンロード
- ✅ 添付資料ダウンロード
- ✅ 既存ファイルスキップ機能
- ✅ エラーハンドリング

### 実行モード
- ✅ 単一企業テスト
- ✅ デバッグモード（HTML保存）
- ✅ 適時開示情報表示
- ✅ 個別ファイルダウンロード
- ✅ 一括ファイルダウンロード
- ✅ バッチ処理

## 📈 実績・テスト結果

**テスト対象**: ソフトバンクグループ（99840）
- **適時開示情報**: 477件取得成功
- **XBRLファイル**: 44件ダウンロード成功（185-226KB）
- **HTMLサマリー**: 42件取得成功（68-206KB）
- **添付資料**: 11件ダウンロード成功（1.9-2.4MB）

## ⚠️ 注意事項

### 利用制限
- JPXサーバーへの負荷軽減のため、リクエスト間隔を設定
- 大量データ取得時は段階的に実行することを推奨

### データ取得の精度
- HTMLテーブル構造の変更により取得エラーが発生する可能性
- 証券コードは5桁で入力（4桁の場合は末尾に0を付加）

## 📁 ファイル出力仕様

### ディレクトリ構造
```
downloads/
├── xbrl/
│   └── {証券コード}/
│       ├── 2025-08-07_99840_2026年３月期第１四半期決算短信_xbrl.zip
│       └── 2025-05-08_99840_2025年３月期決算短信_xbrl.zip
├── html_summary/
│   └── {証券コード}/
│       ├── 2025-08-07_99840_2026年３月期第１四半期決算短信_summary.htm
│       └── 2025-05-08_99840_2025年３月期決算短信_summary.htm
└── attachments/
    └── {証券コード}/
        ├── 2025-08-07_99840_2026年３月期第１四半期決算短信_attachments.htm
        └── 2025-05-08_99840_2025年３月期決算短信_attachments.htm

data/
├── {証券コード}_{YYYYMMDD_HHMMSS}.json  # 単一企業データ
└── batch_result_{YYYYMMDD_HHMMSS}.json  # バッチ処理結果
```

### ファイル命名規則（v2.0対応）
- **統一形式**: `{開示日}_{証券コード}_{表題}_{種類}.{拡張子}`
- **日付形式**: `YYYY-MM-DD` (例: 2025-08-07)
- **種類識別**: 
  - `_xbrl.zip`: 構造化財務データ
  - `_summary.htm`: HTMLサマリー（iXBRL）
  - `_attachments.htm`: 添付資料
- **表題**: 決算短信の完全なタイトルを保持
- **安全性**: ファイルシステムで使用できない文字は自動除去

注意:
- 実装ではファイル名に「証券コード」を含めています（例: `2025-08-07_99840_...`）

### 既存ファイルの扱い（実装準拠）
- HTMLサマリー・添付資料・XBRL: 同名ファイルが既に存在する場合はスキップします（メッセージ:「→ スキップ: 同名ファイルが既に存在します」）。
- 不完全ファイル（例: 0バイト）の場合は再ダウンロードして上書き保存します。

### 企業間待機（負荷分散・jitter）
- 企業ごとの処理間に待機時間を挟みます。
- 範囲指定で一様ランダム待機を設定できます。
  - `--delay-min` と `--delay-max` を指定すると、`[min, max]` 秒の範囲でランダムに待機します。
  - 例: `--delay-min=2 --delay-max=6` → 2〜6秒のランダム待機。
- 互換動作: `--delay` のみ指定時は固定待機（`delay-min = delay-max = delay` と同等）。
- 未指定時のデフォルトは固定3秒です。

## 🧩 安定化と負荷対策（設計方針）
- 1社あたりの開示情報は1回だけ取得し、HTML/添付/XBRLで共有（過剰アクセスを抑制）。
- 企業間待機は範囲指定（`--delay-min/--delay-max`）でランダム化し、アクセスの集中を平準化。
- アイテム単位の待機は「成功ダウンロード時のみ1秒」。スキップ時は待機しません。
- これらにより、過去に発生した 503（Service Unavailable）を抑制しつつ、スループットを確保しています。

## 🔮 今後の拡張予定

- [ ] XBRLデータの自動パースィング機能
- [ ] 財務指標の時系列分析機能
- [ ] データベース連携
- [ ] Web API化
- [ ] グラフィカル表示機能

## 🤝 貢献方法

1. Issue報告
2. プルリクエスト
3. 機能改善提案

## 📄 ライセンス

このプロジェクトはMITライセンスの下で公開されています。

## 📞 サポート

技術的な質問や改善提案は、GitHubのIssueまでお寄せください。

---

**開発者**: Claude AI Assistant  
**最終更新**: 2025年8月23日
