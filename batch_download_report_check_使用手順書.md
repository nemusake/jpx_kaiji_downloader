# batch_download_report_check.py 使用手順書

## 1. はじめに
本ツールは、東証上場会社情報サービスからダウンロードした結果を確認するためのツールです。
`kaiji_downloader.py`で生成されたレポートファイルから、ダウンロードに成功した企業の一覧をCSVファイルとして抽出します。

## 2. 事前準備

### 2.1 必要な環境
- Python 3.11以上がインストールされていること
- `kaiji_downloader.py`を実行してレポートファイルが生成されていること

### 2.2 ファイルの確認
```bash
# Pythonのバージョン確認
python3 --version

# レポートファイルの確認
ls data/batch_download_report_*.json
```

## 3. 基本的な使い方（対話式）

### ステップ1: スクリプトを実行
```bash
uv run python batch_download_report_check.py
```

### ステップ2: ファイル一覧から選択
実行すると以下のような画面が表示されます：
```
batch_download_reportファイルを検索中...

利用可能なレポートファイル:
------------------------------------------------------------
 1. batch_download_report_20250912_175054.json
    サイズ: 1.54 MB
    更新日時: 2025-09-12 17:50:54

 2. batch_download_report_20250911_093022.json
    サイズ: 1.23 MB
    更新日時: 2025-09-11 09:30:22

処理するファイルの番号を入力してください (1-2): 
```

### ステップ3: 番号を入力
処理したいファイルの番号を入力してEnterキーを押します：
```
処理するファイルの番号を入力してください (1-2): 1
```

### ステップ4: 処理完了
自動的に処理が実行され、結果が表示されます：
```
選択されたファイル: batch_download_report_20250912_175054.json
JSONファイルを読み込み中...
  ✓ 14330: 企業名 (成功ファイル数: 1)
  ✓ 14360: 企業名 (成功ファイル数: 1)
  ...

集計結果:
  総企業数: 3794
  成功企業数: 122

CSVファイルに出力中: batch_download_report_20250912_175054_successful_stocks.csv
  122件のデータを出力しました

処理が完了しました。出力ファイル: batch_download_report_20250912_175054_successful_stocks.csv
```

## 4. その他の使い方

### 4.1 特定のファイルを直接指定
```bash
# ファイルを直接指定
uv run python batch_download_report_check.py data/batch_download_report_20250912_175054.json
```

### 4.2 出力ファイル名も指定
```bash
# 入力ファイルと出力ファイルを両方指定
uv run python batch_download_report_check.py data/report.json output/success_list.csv
```

### 4.3 処理のキャンセル
- ファイル選択時に何も入力せずEnterキーを押すとキャンセル
- 処理中にCtrl+Cを押すといつでも中断可能

## 5. 出力ファイルの活用

### 5.1 出力ファイルの形式
CSVファイルには以下の項目が含まれます：
- **stock_code**: 証券コード
- **company_name**: 企業名
- **success_files**: ダウンロードに成功したファイル数

### 5.2 Excelでの開き方
1. 生成されたCSVファイルをダブルクリック
2. Excelが自動的に開きます（BOM付きのため文字化けしません）

### 5.3 出力ファイルの場所
- 対話式モード: カレントディレクトリ（実行ディレクトリ）に自動生成
  - ファイル名: `元のファイル名_successful_stocks.csv`
- 直接指定モード: 指定した場所に生成

補足:
- 対話式モードは `data/batch_download_report_*.json` を対象に検索します。別ディレクトリにあるJSONを処理したい場合は、直接指定モードでパスを渡してください。

## 6. トラブルシューティング

### Q1: 「dataフォルダにファイルが見つかりません」と表示される
**A:** 以下を確認してください：
- dataフォルダが存在するか
- batch_download_report_*.jsonファイルが存在するか
- スクリプトを正しいディレクトリから実行しているか

### Q2: 文字化けする
**A:** BOM付きUTF-8で出力しているため、通常は文字化けしません。
もし文字化けする場合は、テキストエディタで開いてエンコーディングを確認してください。

### Q3: 「JSONファイルの解析に失敗しました」と表示される
**A:** レポートファイルが破損している可能性があります。
`kaiji_downloader.py`を再実行してレポートファイルを再生成してください。

### Q4: 出力されるCSVファイルが空
**A:** すべての企業のダウンロードが失敗している可能性があります。
`kaiji_downloader.py`の実行ログを確認してください。

## 7. 活用例

### 7.1 成功した企業のみで再処理
抽出したstock_codeリストを使って、成功した企業のみを対象に追加処理を実行できます。

### 7.2 失敗した企業の特定
総企業数と成功企業数の差から、失敗した企業数を把握できます。

### 7.3 定期的な監視
定期的に実行して、ダウンロード成功率の推移を確認できます。

## 8. 注意事項
- 大きなJSONファイル（10MB以上）の処理には時間がかかる場合があります
- 既存の出力ファイルは確認なしに上書きされます
- dataフォルダに多数のレポートファイルがある場合、一覧表示が長くなります

## 9. 関連ツール
- `kaiji_downloader.py`: レポートファイルを生成する元のダウンローダー
- `html_summary_output.py`: ダウンロードしたデータの解析ツール
- `html_summary_join.py`: 複数のデータを結合するツール

## 10. サポート
問題が発生した場合は、以下の情報と共に報告してください：
- Pythonのバージョン
- エラーメッセージの全文
- 使用したコマンド
- レポートファイルのサイズと更新日時
