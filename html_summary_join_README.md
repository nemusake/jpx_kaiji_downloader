# HTML Summary CSV結合ツール

## 概要
`html_summary_join.py`は、東証上場会社情報サービスから取得した各企業の決算情報CSVファイルを1つのファイルに結合するツールです。

## 特徴
- **ポータブル性**: Python標準ライブラリのみ使用（外部依存なし）
- **柔軟な範囲指定**: 日付範囲、証券コード範囲、全結合に対応
- **データクレンジング**: 4桁証券コードの自動正規化機能
- **相対パス参照**: 実行場所から相対的にoutput/html_summaryフォルダを参照
- **大量データ対応**: 1600以上のファイルを効率的に処理

## 必要要件
- Python 3.x
- output/html_summaryフォルダ内にCSVファイル

## ファイル構成
```
.
├── html_summary_join.py         # 実行ファイル
├── output/
│   ├── html_summary/            # 入力CSVファイル格納場所
│   │   ├── 13010.csv
│   │   ├── 13320.csv
│   │   └── ...
│   ├── html_summary_all.csv     # 全結合出力
│   ├── html_summary_date_*.csv  # 日付範囲出力
│   └── html_summary_code_*.csv  # 証券コード範囲出力
```

## 使用方法

### ヘルプ表示
```bash
python3 html_summary_join.py
```

### 全CSVファイル結合
```bash
python3 html_summary_join.py all
```
出力: `output/html_summary_all.csv`

### 日付範囲指定
```bash
python3 html_summary_join.py 20200101-20201231
```
出力: `output/html_summary_date_20200101-20201231.csv`

### 証券コード範囲指定
```bash
python3 html_summary_join.py 13000-14000
```
出力: `output/html_summary_code_13000-14000.csv`

### 証券コードクレンジング
```bash
python3 html_summary_join.py cleansing
```
出力: 各CSVファイルを直接更新（4桁証券コードを5桁に正規化）

## 証券コード範囲指定の詳細

### 文字列比較による範囲判定
証券コードの範囲は文字列比較（辞書順）で判定されます。

#### 数字のみの証券コード
```bash
python3 html_summary_join.py 13000-13999
```
- 含まれる: 13000, 13010, 13020, ..., 13999
- 含まれない: 130A0, 130B0など（アルファベット付き）

#### アルファベット付き証券コードを含める
```bash
python3 html_summary_join.py 13000-139ZZ
```
- 含まれる: 13000〜13999の数字コード + 130A0〜139Z9などのアルファベット付きコード

### 文字列比較の順序例
```
"13000" < "13099" < "130A0" < "130Z0" < "13100" < "13999" < "139A0" < "139ZZ" < "14000"
```

## 出力CSVフォーマット

### カラム構成
- date: 日付
- filing_date: 提出日
- code: 証券コード
- company_name: 会社名
- fiscal_year_end: 会計年度末
- quarterly_period: 四半期期間
- factor_tag: 要素タグ
- factor_jp: 要素名（日本語）
- value: 値
- has_value: 値の有無
- is_nil: nil判定
- data_type: データ型

## 処理の仕組み

### ファイル選択
1. **all指定**: 4-5文字の英数字ファイル名のCSVを全て対象
2. **日付範囲**: 全CSVを読み込み、dateカラムでフィルタリング
3. **証券コード範囲**: ファイル名で範囲判定してから読み込み
4. **cleansing**: ファイル名が4〜5文字の英数字のCSVのみ対象。証券コードとvalueカラム（数値）の全角→半角およびカンマ除去を実施

### メモリ効率
- ファイルを1つずつ読み込んで処理
- 進捗表示で処理状況を可視化
- エラーファイルはスキップして継続

### エンコーディング対応
- UTF-8 BOM付きファイルに対応（utf-8-sig）
- 出力もUTF-8 BOMを付与

### 日付カラムの前提
- CSVの`date`カラムは`YYYY-MM-DD`形式を想定してフィルタリングします

### クレンジング機能
- 証券コードの全角英数字を半角に正規化（例: `１３３３０` → `13330`）
- 4桁の証券コード（例: `1333`）を5桁（例: `13330`）に自動修正
- valueカラムが数値データの場合：
  - 全角数字を半角に正規化（例: `１，２３４` → `1234`）
  - 3桁区切りカンマを除去（例: `"1,234,567"` → `1234567`）
- ファイル名と証券コードの整合性チェック
- 修正が必要なファイルのみ更新（効率的処理）
- 修正結果の詳細レポート表示（証券コード修正数・value修正数を個別表示）
  - 注: 表示される「valueカンマ除去レコード数」には、全角→半角のみの変更が行われた行も含まれます（valueの内容が変化した行の総数）

## エラーハンドリング
- 破損したCSVファイルは警告を出してスキップ
- 日付パースエラーは該当行をスキップ
- 処理は継続され、正常なデータのみ出力

## 注意事項
- 大量ファイルの全結合は時間がかかります（1600ファイルで数分程度）
- 出力ファイルは大容量になる可能性があります（全結合で数GB）
- 既存の出力ファイルは上書きされます
- 日付フィルタはCSVの`date`カラムが`YYYY-MM-DD`形式であることを前提とします

## トラブルシューティング

### CSVファイルが見つからない
- output/html_summaryフォルダが存在するか確認
- 実行場所からの相対パスが正しいか確認

### メモリ不足エラー
- 日付範囲や証券コード範囲を狭めて実行
- システムのメモリを増やす

### 文字化け
- 入力CSVがUTF-8形式か確認
- Excelで開く場合はUTF-8 BOM付きで出力されるので問題ないはず

## ライセンス
内部利用ツール

## 作成者
Claude (Anthropic)

## 更新履歴
- 2025-08-27: 全角→半角変換機能追加
  - 証券コードの全角英数字を半角に正規化機能実装
  - valueカラムの数値データに対する全角数字→半角数字変換機能実装
  - 既存のカンマ除去機能と統合し包括的な数値正規化を実現
- 2025-08-25: valueカラムクレンジング機能追加
  - valueカラムの3桁区切りカンマ除去機能実装
  - SQLite3データベース格納用の数値形式に変換
  - Python標準ライブラリのみで実装（ポータブル性維持）
- 2024-08-24: cleansing機能追加
  - 証券コードクレンジング機能実装
  - 4桁コードの自動5桁化
  - 修正結果レポート機能追加
- 2024-08-25: 初版作成
  - 基本機能実装（日付範囲、証券コード範囲）
  - allコマンド追加
  - 出力ファイル名形式の統一
